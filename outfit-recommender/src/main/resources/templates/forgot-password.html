<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout (~{::title}, ~{::main})}">
<head>
    <title>비밀번호 재설정</title>
    <meta charset="UTF-8"/>
</head>
<main th:fragment="main">
    <h1>비밀번호 재설정</h1>

    <form id="pwResetForm">
        <label>가입 이메일
            <input type="email" id="resetEmail" required>
        </label>
        <button type="button" id="btnSendCode">인증코드 발송</button>
        <br/>

        <label>인증코드
            <input type="text" id="resetCode" maxlength="10" required>
        </label><br/>

        <label>새 비밀번호
            <input type="password" id="newPassword" required minlength="8">
        </label><br/>

        <button type="submit">비밀번호 변경</button>
    </form>

    <script>
        // 인증코드 발송
        const sendBtn = document.getElementById('btnSendCode');
        let cooldownUntil = 0;

        sendBtn.addEventListener('click', sendCode);

        async function sendCode() {
            const now = Date.now();
            if (now < cooldownUntil) {
                const sec = Math.ceil((cooldownUntil - now) / 1000);
                alert(`${sec}초 후 다시 시도해 주세요.`);
                return;
            }

            const email = document.getElementById('resetEmail').value.trim();
            if (!email) {
                alert('이메일을 입력하세요');
                return;
            }

            try {
                const r = await fetch('/auth/password/request', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email})
                });
                if (!r.ok) {
                    const err = await r.text().catch(() => '메일 발송 실패');
                    throw new Error(err || '메일 발송 실패');
                }
                alert('인증코드가 이메일로 발송되었습니다.');
                // 60초 쿨다운 시작
                cooldownUntil = Date.now() + 60 * 1000;
                tick();
            } catch (e) {
                alert(e.message || '메일 발송 실패');
            }
        }

        function tick() {
            const now = Date.now();
            if (now >= cooldownUntil) {
                sendBtn.disabled = false;
                sendBtn.textContent = '인증코드 발송';
                return;
            }
            sendBtn.disabled = true;
            sendBtn.textContent = `재발송(${Math.ceil((cooldownUntil - now) / 1000)}s)`;
            requestAnimationFrame(tick);
        }

        // 코드 먼저 확인
        async function verifyCodeOnly() {
            const email = document.getElementById('resetEmail').value.trim();
            const code = document.getElementById('resetCode').value.trim();
            const r = await fetch('/auth/password/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, code})
            });
            return r.ok;
        }

        // 새 비밀번호 적용
        document.getElementById('pwResetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                email: document.getElementById('resetEmail').value.trim(),
                code: document.getElementById('resetCode').value.trim(),
                newPassword: document.getElementById('newPassword').value.trim()
            };

            if (!payload.email || !payload.code || !payload.newPassword) {
                alert('모든 값을 입력하세요.');
                return;
            }

            try {
                const res = await fetch('/auth/password/reset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const txt = await res.text().catch(() => '');
                if (!res.ok) throw new Error(txt || '비밀번호 변경 실패');

                alert('비밀번호가 변경되었습니다. 다시 로그인하세요.');
                location.href = '/login';
            } catch (err) {
                alert(err.message || '비밀번호 변경 실패');
            }
        });
    </script>

</main>
</html>
