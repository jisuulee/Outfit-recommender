<!-- templates/signup.html -->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout (~{::title}, ~{::main})}">
<head>
    <title>회원가입</title>
    <meta charset="UTF-8"/>
    <style>
        .hint{display:block;color:#6b7280;font-size:12px;margin-top:4px}
        .ok{color:#16a34a}
        .err{color:#dc2626}
        .row{display:flex;gap:8px;align-items:center}
        .row > input{flex:1}
        .muted{opacity:.6;pointer-events:none}
    </style>
</head>

<main class="container" th:fragment="main">
    <h1>회원가입</h1>

    <form id="signupForm" class="form" novalidate>
        <label>이름
            <input name="name" required>
        </label>

        <label>나이
            <input name="age" type="number" min="0" step="1" required>
        </label>

        <fieldset style="border:0; padding:0; margin:8px 0">
            <legend style="font-weight:600">성별</legend>
            <label style="margin-right:12px">
                <input type="radio" name="gender" value="남" checked> 남
            </label>
            <label style="margin-right:12px">
                <input type="radio" name="gender" value="여"> 여
            </label>
            <label>
                <input type="radio" name="gender" value="기타"> 기타
            </label>
        </fieldset>

        <!-- ✅ 이메일 사전 인증 (OTP + JSON API) -->
        <label>이메일
            <div class="row">
                <input name="email" type="email" required>
                <button type="button" id="btnSend">인증코드 발송</button>
            </div>
            <small id="emailHint" class="hint">이메일 인증을 완료해야 가입이 가능합니다.</small>
        </label>

        <label>인증코드
            <div class="row">
                <input name="emailCode" maxlength="10" placeholder="메일로 받은 코드" autocomplete="one-time-code">
                <button type="button" id="btnVerify" class="muted" disabled>인증확인</button>
            </div>
            <small id="verifyHint" class="hint">메일의 인증코드를 입력한 뒤 ‘인증확인’을 누르세요.</small>
        </label>

        <label>아이디
            <input name="username" required>
        </label>

        <label>비밀번호
            <input name="password" type="password" required minlength="8" autocomplete="new-password">
        </label>

        <label>비밀번호 확인
            <input name="passwordConfirm" type="password" required minlength="8" autocomplete="new-password">
        </label>

        <!-- ✅ 인증 전까지 비활성화 -->
        <button type="submit" id="btnSignup" disabled>가입</button>
    </form>

    <p><a th:href="@{/login}">로그인</a></p>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const PURPOSE = 'SIGN_UP'; // ✅ API 요구사항에 맞춘 purpose 고정

            const form = document.getElementById('signupForm');
            const emailInput = form.querySelector('input[name="email"]');
            const codeInput  = form.querySelector('input[name="emailCode"]');
            const btnSend    = document.getElementById('btnSend');
            const btnVerify  = document.getElementById('btnVerify');
            const btnSignup  = document.getElementById('btnSignup');

            const emailHint  = document.getElementById('emailHint');
            const verifyHint = document.getElementById('verifyHint');

            let emailVerified = false;
            let cooldownTimer = null;
            const COOLDOWN_SEC = 60; // 재발송 쿨다운(선택)

            function setVerified(v, msgOk, msgNot) {
                emailVerified = v;
                btnSignup.disabled = !v;
                emailHint.textContent = v ? (msgOk || '이메일 인증이 완료되었습니다!') : (msgNot || '이메일 인증을 완료해야 가입이 가능합니다.');
                emailHint.className = 'hint ' + (v ? 'ok' : '');
            }

            function setVerifyEnabled(v) {
                btnVerify.disabled = !v;
                btnVerify.classList.toggle('muted', !v);
            }

            function startCooldown() {
                let remain = COOLDOWN_SEC;
                btnSend.disabled = true;
                btnSend.classList.add('muted');
                const orig = '인증코드 발송';
                btnSend.textContent = `${orig} (${remain}s)`;
                cooldownTimer = setInterval(() => {
                    remain -= 1;
                    btnSend.textContent = `${orig} (${remain}s)`;
                    if (remain <= 0) {
                        clearInterval(cooldownTimer);
                        btnSend.disabled = false;
                        btnSend.classList.remove('muted');
                        btnSend.textContent = orig;
                    }
                }, 1000);
            }

            // 이메일/코드 입력 변화 시 상태 갱신
            emailInput.addEventListener('input', () => {
                // 이메일이 바뀌면 다시 인증 필요
                setVerified(false, null, '이메일이 변경되어 다시 인증이 필요합니다.');
                setVerifyEnabled(false);
            });
            codeInput.addEventListener('input', () => {
                setVerifyEnabled(!!codeInput.value.trim());
            });

            // ✅ 인증코드 발송 (JSON 본문)
            btnSend.addEventListener('click', async () => {
                const email = (emailInput.value || '').trim();
                if (!email) { alert('이메일을 입력하세요.'); emailInput.focus(); return; }

                try {
                    const res = await fetch('/auth/email/send', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email, purpose: PURPOSE })
                    });
                    if (!res.ok) {
                        let msg = '인증코드 발송에 실패했습니다.';
                        try { const err = await res.json(); if (err && err.message) msg = err.message; } catch(_){}
                        throw new Error(msg);
                    }
                    const json = await res.json().catch(()=>({}));
                    alert(json.message || '인증코드를 발송했습니다. 메일함을 확인하세요.');
                    setVerifyEnabled(true);
                    startCooldown(); // 선택: 재발송 쿨다운
                } catch (e) {
                    alert(e.message || '인증코드 발송에 실패했습니다.');
                }
            });

            // ✅ 인증확인 (JSON 본문)
            btnVerify.addEventListener('click', async () => {
                const email = (emailInput.value || '').trim();
                const code  = (codeInput.value  || '').trim();
                if (!email) { alert('이메일을 입력하세요.'); emailInput.focus(); return; }
                if (!code)  { alert('인증코드를 입력하세요.'); codeInput.focus(); return; }

                try {
                    const res = await fetch('/auth/email/verify', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email, purpose: PURPOSE, code })
                    });
                    const json = await res.json().catch(()=>({}));

                    if (!res.ok) {
                        // 서버가 400/409 등과 함께 message를 내려줄 수 있음
                        const msg = json && json.message ? json.message : '인증확인에 실패했습니다.';
                        throw new Error(msg);
                    }

                    // API가 { verified: true/false } 형태면 여기서 확인
                    if (json.verified === false) {
                        setVerified(false, null, '코드가 올바르지 않거나 만료되었습니다.');
                        alert('코드가 올바르지 않거나 만료되었습니다.');
                        return;
                    }

                    setVerified(true, '이메일 인증이 완료되었습니다!');
                    verifyHint.textContent = '인증이 확인되었습니다. 이제 가입할 수 있습니다.';
                    verifyHint.className = 'hint ok';
                    alert('인증이 완료되었습니다!');
                } catch (e) {
                    setVerified(false, null, e.message || '인증확인에 실패했습니다.');
                    alert(e.message || '인증확인에 실패했습니다.');
                }
            });

            // ✅ 최종 가입 (백엔드에서도 사전 인증 여부를 다시 검증해야 안전)
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!emailVerified) {
                    alert('이메일 인증을 먼저 완료해주세요.');
                    return;
                }

                // 기본 폼 검증
                const fd = new FormData(form);
                const data = Object.fromEntries(fd.entries());
                if (data.age !== undefined && data.age !== '') data.age = Number(data.age);

                if (!data.password || !data.passwordConfirm) { alert('비밀번호와 비밀번호 확인을 모두 입력해주세요.'); return; }
                if (data.password !== data.passwordConfirm) { alert('비밀번호가 일치하지 않습니다.'); return; }
                if (data.password.length < 8) { alert('비밀번호는 8자 이상이어야 합니다.'); return; }

                try {
                    // 기존에 쓰던 window.api 사용(프로젝트 헬퍼). 없다면 fetch로 바꿔도 OK.
                    const res = await (window.api ? window.api('/api/users/signup', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    }) : fetch('/api/users/signup', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify(data)
                    }));

                    if (!res.ok) {
                        let msg = '가입 실패';
                        try { const err = await res.json(); if (err && err.message) msg = err.message; } catch(_){}
                        alert(msg); return;
                    }

                    alert('회원가입이 완료되었습니다!');
                    location.href = '/login';
                } catch {
                    alert('네트워크 오류로 가입에 실패했습니다.');
                }
            });
        });
    </script>
</main>
</html>
